<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>麥當勞單點專用_多人共用版 v3（Web）</title>
<style>
  :root{--bg:#0b0f14;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--border:#1f2937}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 14px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .toolbar .btn,.btn{background:#1f2937;border:1px solid #2b3446;color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
  .toolbar .btn:hover,.btn:hover{border-color:#3a4a66}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .sound{display:flex;align-items:center;gap:8px;color:var(--muted)}
  select,input[type="text"],input[type="number"]{background:#0b1220;border:1px solid #22324a;color:#e5e7eb;padding:8px;border-radius:10px}
  input[type="number"]{width:86px;text-align:center}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
  th{color:#cbd5e1;font-weight:600}
  .timeSoon{color:var(--warn)}
  .timeDue{color:var(--bad);font-weight:700}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #2a3a56;border-radius:999px;color:#93c5fd;background:#0b1220}
  .muted{color:var(--muted)}
  .footer{margin-top:8px;font-size:12px;color:#94a3b8}
  .hidden{display:none!important}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{width:360px;max-width:92vw;background:#121826;border:1px solid #1f2a44;border-radius:14px;padding:18px}
  .modal h3{margin:0 0 10px;font-size:18px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .modal button{background:#1f2937;border:1px solid var(--border);color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
  .modal button.primary{background:#2563eb;border-color:#2563eb}
  .time-ctrl{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
  .time-unit{display:flex;align-items:center;gap:8px}
  .time-col{display:flex;flex-direction:column;gap:6px}
  .btn.small{padding:2px 6px;font-size:12px}
  .btn.small.square{width:38px;padding:6px 0;font-size:12px;text-align:center}
  tr.rowMap{ border-left:6px solid transparent; }
  .mapBadge{ display:inline-flex; align-items:center; gap:8px; justify-content:center }
  .mapDot{ width:10px;height:10px;border-radius:50%; display:inline-block }
  tr.rowMap[data-soft]{ background: var(--row-soft); }
  .timeStrike{ text-decoration: line-through; opacity:.65 }
  .pw-msg{margin-top:8px;font-size:12px;color:#9fb2d1}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid #2b3446;color:#cbd5e1}
  .btn.active{background:#2563eb;border-color:#2563eb}

  /* Notices bar */
  #noticesBar{display:flex;flex-direction:column;gap:6px;margin:4px 0 10px}
  .notice{display:flex;align-items:center;gap:10px;padding:8px 10px;border:1px solid #233047;border-radius:10px;background:#0e1420}
  .notice .dot{width:10px;height:10px;border-radius:50%;display:inline-block}
  .notice .t{color:#9fb2d1;font-size:12px}
  .n-green .dot{background:#22c55e}
  .n-red .dot{background:#ef4444}
  .n-orange .dot{background:#f59e0b}
  .n-blue .dot{background:#60a5fa}
</style>
</head>
<body>

<div class="container">
  <h1>
    麥當勞單點專用_多人共用版 v3
    <span id="rtStatus" class="badge">Realtime: …</span>
    <span id="onlineBadge" class="badge">Online: 0</span>
  </h1>

  <div class="card">
    <div class="grid" style="display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px">
      <div>
        <div class="muted" style="margin-bottom:6px">章節 (EP)</div>
        <select id="ep"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">地圖名稱</div>
        <select id="map"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">等級</div>
        <input id="level" type="text" readonly>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">分流</div>
        <select id="channel"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">倒數時間</div>
        <div class="time-ctrl">
          <div class="time-unit">
            <div class="time-col">
              <button class="btn small square plusminus" data-target="hh" data-delta="-1">-1</button>
              <button class="btn small square plusminus" data-target="hh" data-delta="-5">-5</button>
            </div>
            <input id="hh" type="number" value="0" min="0" max="99" />
            <div class="time-col">
              <button class="btn small square plusminus" data-target="hh" data-delta="1">+1</button>
              <button class="btn small square plusminus" data-target="hh" data-delta="5">+5</button>
            </div>
            <span class="muted">時</span>
          </div>

          <div class="time-unit">
            <div class="time-col">
              <button class="btn small square plusminus" data-target="mm" data-delta="-1">-1</button>
              <button class="btn small square plusminus" data-target="mm" data-delta="-5">-5</button>
            </div>
            <input id="mm" type="number" value="0" min="0" max="59" />
            <div class="time-col">
              <button class="btn small square plusminus" data-target="mm" data-delta="1">+1</button>
              <button class="btn small square plusminus" data-target="mm" data-delta="5">+5</button>
            </div>
            <span class="muted">分</span>
          </div>

          <div class="time-unit">
            <div class="time-col">
              <button class="btn small square plusminus" data-target="ss" data-delta="-1">-1</button>
              <button class="btn small square plusminus" data-target="ss" data-delta="-5">-5</button>
            </div>
            <input id="ss" type="number" value="0" min="0" max="59" />
            <div class="time-col">
              <button class="btn small square plusminus" data-target="ss" data-delta="1">+1</button>
              <button class="btn small square plusminus" data-target="ss" data-delta="5">+5</button>
            </div>
            <span class="muted">秒</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <div class="toolbar">
        <button class="btn" id="addBtn">新增 BOSS</button>
        <button class="btn" id="copyCheckedBtn">複製勾選</button>
        <button class="btn" id="copyAllBtn">複製全部</button>
        <button class="btn" id="delCheckedBtn">清除勾選</button>
        <button class="btn" id="delAllBtn">清除全部</button>
        <button class="btn" id="shiftBtn">分流後移</button>
      </div>
      <div class="sound">
        <label><input type="checkbox" id="soundToggle" checked> 啟用提示鈴聲</label>
        <span>提前提示</span>
        <select id="alertBefore">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="5">5</option>
          <option value="10">10</option>
        </select>
        <span>分鐘</span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <!-- EP Filter bar -->
    <div class="toolbar" id="epFilterBar" style="margin:2px 0 6px"></div>
<div style="display:flex;gap:10px;align-items:center;margin:0 0 8px">
  <select id="mapFilter" style="min-width:260px"></select>
</div>
    <!-- Global notices (site-wide) -->
    <div id="noticesBar"></div>

    <table id="list">
      <thead>
        <tr>
          <th>✔</th>
          <th>章節</th>
          <th>地圖名稱</th>
          <th>等級</th>
          <th>分流</th>
          <th>時間</th>
        </tr>
      </thead>
    <tbody id="tbody"></tbody>
    </table>
    <div class="footer">依時間（實際到點）排序；相同「章節+地圖+分流」新增第二次會覆蓋第一次；資料儲存在瀏覽器的 localStorage；主資料來自 Supabase（已啟用 Realtime 自動同步）。</div>
  </div>
</div>

<!-- 密碼遮罩（RPC 驗證） -->
<div id="pwOverlay" class="overlay">
  <div class="modal">
    <h3>密碼驗證</h3>
    <p class="muted" style="margin:6px 0 10px">請輸入密碼才能進入（伺服器驗證）。</p>
    <input id="pwInput" type="password" placeholder="密碼" style="width:100%">
    <div class="actions">
      <button id="pwCancel">離開</button>
      <button id="pwOk" class="primary">確定</button>
    </div>
    <div id="pwMsg" class="pw-msg"></div>
  </div>
</div>

<!-- 分流後移對話框 -->
<div id="shiftOverlay" class="overlay hidden">
  <div class="modal" style="width:420px">
    <h3>分流後移</h3>
    <div class="muted" style="margin:6px 0 4px">章節 (EP)</div>
    <select id="shiftEp" style="width:100%"></select>
    <div class="muted" style="margin:10px 0 4px">地圖名稱</div>
    <select id="shiftMap" style="width:100%"></select>
    <div class="muted" style="margin:10px 0 4px">插入的分流號（從這個分流開始往後 +1）</div>
    <input id="shiftAt" type="number" min="1" step="1" value="1" style="width:100%">
    <div class="actions">
      <button id="shiftCancel">取消</button>
      <button id="shiftOk" class="primary">確定後移</button>
    </div>
    <div id="shiftMsg" class="muted" style="margin-top:8px;font-size:12px"></div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
/** ========= Supabase ========= */
const SUPABASE_URL = "https://pvgisrubrsitesqpiimr.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2Z2lzcnVicnNpdGVzcXBpaW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MDExNjMsImV4cCI6MjA3MzA3NzE2M30.TQh3vDTpUkDJA58wA7EN3msFTHhz0c72TEXCl1Lg1zc";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/** ========= 靜態資料 ========= */
const EP_MAP_LEVEL = {
  "EP1": {"夏奧雷伊西邊森林":"Lv.1","夏奧雷伊東邊森林":"Lv.3","蓮帕拉沙池塘":"Lv.5","夏奧雷伊礦山村莊":"Lv.7","水晶礦山":"Lv.9"},
  "EP2": {"斯拉屋塔斯峽谷":"Lv.10","凱利高原":"Lv.11","奈普里塔斯懸崖":"Lv.12","泰內花園":"Lv.13","泰內聖堂地下1層":"Lv.15","泰內聖堂上1層":"Lv.17","泰內聖堂上2層":"Lv.19"},
  "EP3": {"庫魯森林":"Lv.20","克尼多斯森林":"Lv.21","達旦森林":"Lv.22","諾巴哈公會所":"Lv.24","諾巴哈別館":"Lv.26","諾巴哈本院":"Lv.28"},
  "EP4": {"貝雅山谷":"Lv.30","比爾塔溪谷":"Lv.31","科博爾特森林":"Lv.32","賽提尼山溝":"Lv.34","培爾克神殿":"Lv.36","安森塔水源地":"Lv.38"},
  "EP5": {"卡羅利斯泉水":"Lv.40","萊塔斯小溪":"Lv.42","德慕蘭佃農村":"Lv.44","德慕蘭莊園":"Lv.46","德慕蘭外城":"Lv.48"},
  "EP6": {"達伊納養蜂地":"Lv.50","比爾那森林":"Lv.51","烏奇斯耕作地":"Lv.52","春光樹林":"Lv.53","關口路":"Lv.55","史爾特凱拉特林":"Lv.57","克巴伊拉斯森林":"Lv.59"},
  "EP7": {"魯卡斯高原":"Lv.60","王之高原":"Lv.61","札卡里耶爾交叉路":"Lv.62","王陵1層":"Lv.64","王陵2層":"Lv.66","王陵3層":"Lv.68"},
  "EP8": {"水路橋地區":"Lv.70","魔族收監所第1區":"Lv.71","魔族收監所第3區":"Lv.72","魔族收監所第4區":"Lv.73","魔族收監所第5區":"Lv.74"},
  "EP9": {"女神的古院":"Lv.75","佩迪米安外城":"Lv.76","魔法師之塔1層":"Lv.77","魔法師之塔2層":"Lv.78","魔法師之塔3層":"Lv.79"},
  "EP10":{"大教堂懺悔路":"Lv.80","大教堂正殿":"Lv.81","大教堂大迴廊":"Lv.82","大教堂至聖所":"Lv.83"},
};
const CHANNELS = Array.from({length:10}, (_,i)=>String(i+1));

/** ========= 狀態 ========= */
const state = {
  entries: {},  // key `${ep}||${map}||${channel}` → row
  soundEnabled: true,
  alertBeforeMin: 0,
  filterEp: 'ALL', // 本機篩選（不同步）
  filterMap: 'ALL',
};
let notices = []; // 最多 3 則

/** ========= DOM ========= */
const epSel=document.getElementById('ep');
const mapSel=document.getElementById('map');
const levelInp=document.getElementById('level');
const chSel=document.getElementById('channel');
const hhInp=document.getElementById('hh');
const mmInp=document.getElementById('mm');
const ssInp=document.getElementById('ss');
const tbody=document.getElementById('tbody');
const soundToggle=document.getElementById('soundToggle');
const alertBefore=document.getElementById('alertBefore');
const rtStatus=document.getElementById('rtStatus');
const onlineBadge=document.getElementById('onlineBadge');
const epFilterBar=document.getElementById('epFilterBar');
const mapFilterSel=document.getElementById('mapFilter');
const noticesBar=document.getElementById('noticesBar');

/* 分流後移 */
const shiftOverlay=document.getElementById('shiftOverlay');
const shiftEp=document.getElementById('shiftEp');
const shiftMap=document.getElementById('shiftMap');
const shiftAt=document.getElementById('shiftAt');
const shiftMsg=document.getElementById('shiftMsg');

/** ========= 工具 ========= */
// === Map filter helpers ===
function buildMapOptionsFor(epValue){
  // When ALL, empty dropdown
  if(epValue==='ALL'){
    if(mapFilterSel){
      mapFilterSel.innerHTML = ''; // no options
      state.filterMap = 'ALL';
    }
    return;
  }
  const maps = Object.keys(EP_MAP_LEVEL[epValue]||{});
  const opts = ['<option value="ALL">全部地圖</option>'].concat(maps.map(m=>`<option value="${m}">${m}</option>`));
  mapFilterSel.innerHTML = opts.join('');
  // keep previous selection if still valid
  const cur = state.filterMap || 'ALL';
  if(cur==='ALL' || maps.includes(cur)){ mapFilterSel.value = cur; } else { mapFilterSel.value = 'ALL'; state.filterMap='ALL'; }
}

const pad2 = n => String(n).padStart(2,"0");
const fmtTime = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
function fmtDisplayTime(target){
  const now=new Date();
  const base = fmtTime(target);
  const a=new Date(now); a.setHours(0,0,0,0);
  const b=new Date(target); b.setHours(0,0,0,0);
  const dd=Math.floor((b-a)/86400000);
  return dd===0?base:`${base} (+${dd}d)`;
}
function keyOf(ep,map,channel){return `${ep}||${map}||${channel}`;}

/* 更強的顏色分散：24 色固定調色盤 + 更高飽和/亮度 */

/* 更亮且清楚區分的地圖顏色（36 色輪） */
const HUES = Array.from({length:36}, (_,i)=>i*10); // 0,10,...,350
function strHash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h+s.charCodeAt(i))|0;}return Math.abs(h);}
function mapColor(name){
  const idx = strHash(name) % HUES.length;
  const h = HUES[idx];
  const bg = `hsl(${h}deg 80% 40%)`;           // 左側條 & dot：高飽和、偏深
  const soft = `hsla(${h}, 85%, 65%, 0.35)`;   // 背景：同色亮透明，易區分
  return { bg, soft };
}
function beep(){
  if(!state.soundEnabled) return;
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const osc=ctx.createOscillator();const g=ctx.createGain();
    osc.type='sine';osc.frequency.value=880;osc.connect(g);g.connect(ctx.destination);
    g.gain.setValueAtTime(0.0001,ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2,ctx.currentTime+0.01);
    osc.start();setTimeout(()=>{osc.stop();ctx.close();},200);
  }catch(e){}
}

/** ========= 本地存取 ========= */
const LS_KEY="tomsboss_web_entries";
const LS_PREF="tomsboss_web_pref";
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state.entries));
  localStorage.setItem(LS_PREF, JSON.stringify({soundEnabled:state.soundEnabled, alertBeforeMin:state.alertBeforeMin, filterEp:state.filterEp}));
}
function load(){
  try{const d=JSON.parse(localStorage.getItem(LS_KEY)||"{}"); if(d&&typeof d==="object") state.entries=d;}catch{}
  try{const p=JSON.parse(localStorage.getItem(LS_PREF)||"{}"); if(typeof p?.soundEnabled==="boolean") state.soundEnabled=p.soundEnabled; if(typeof p?.alertBeforeMin==="number") state.alertBeforeMin=p.alertBeforeMin; if(typeof p?.filterEp==="string") state.filterEp=p.filterEp;}catch{}
}

/** ========= 初始化選單 ========= */
function initSelectors(){
  epSel.innerHTML = Object.keys(EP_MAP_LEVEL).map(ep=>`<option value="${ep}">${ep}</option>`).join("");
  chSel.innerHTML = CHANNELS.map(c=>`<option value="${c}">${c}</option>`).join("");
  alertBefore.value = String(state.alertBeforeMin||0);
  soundToggle.checked = !!state.soundEnabled;
  refreshMaps();
  shiftEp.innerHTML = epSel.innerHTML;
  refreshShiftMaps();
}
function refreshMaps(){
  const ep=epSel.value, maps=Object.keys(EP_MAP_LEVEL[ep]||{});
  mapSel.innerHTML = maps.map(m=>`<option value="${m}">${m}</option>`).join("");
  refreshLevel();
}
function refreshLevel(){
  const ep=epSel.value, map=mapSel.value;
  levelInp.value = (EP_MAP_LEVEL[ep]||{})[map] || "";
}
function refreshShiftMaps(){
  const ep=shiftEp.value, maps=Object.keys(EP_MAP_LEVEL[ep]||{});
  shiftMap.innerHTML = maps.map(m=>`<option value="${m}">${m}</option>`).join("");
}

/** ========= EP 篩選（本機） ========= */
function initEpFilter(){
  const eps = ['ALL', ...Object.keys(EP_MAP_LEVEL)];
  epFilterBar.innerHTML = eps.map(ep => {
    const label = ep==='ALL' ? '全部' : ep;
    return `<button class="btn epFilterBtn" data-ep="${ep}">${label}</button>`;
  }).join("");
  epFilterBar.addEventListener('click', e => {
    const btn = e.target.closest('.epFilterBtn'); if(!btn) return;
    state.filterEp = btn.dataset.ep;
    save();
    updateEpFilterUI();
    buildMapOptionsFor(state.filterEp);
    render();
  });
  updateEpFilterUI();
}
function updateEpFilterUI(){
  const btns = epFilterBar.querySelectorAll('.epFilterBtn');
  btns.forEach(b => {
    if(b.dataset.ep === state.filterEp) b.classList.add('active');
    else b.classList.remove('active');
  });
}


// Map dropdown change -> update filter and render
if(mapFilterSel){ mapFilterSel.addEventListener('change', ()=>{ state.filterMap = mapFilterSel.value || 'ALL'; save(); render(); }); }

/** ========= Notices ========= */
function renderNotices(){
  noticesBar.innerHTML = notices.map(n=>{
    const colorClass = n.kind==='add' ? 'n-green'
      : n.kind==='del_checked' ? 'n-red'
      : n.kind==='del_all' ? 'n-orange'
      : 'n-blue';
    const time = new Date(n.created_at||Date.now());
    const tStr = `[${fmtTime(time)}]`;
    let text='';
    if(n.kind==='add'){
      text = `${n.ep} ｜ ${n.map} ｜ ${n.level||''} ｜ 分流 ${n.channel} ｜ BOSS 新增成功`;
    }else if(n.kind==='del_checked'){
      text = `${n.ep} ｜ ${n.map} ｜ ${n.level||''} ｜ 分流 ${n.channel} ｜ BOSS 清除成功`;
    }else if(n.kind==='del_all'){
      text = `全部清除成功`;
    }else if(n.kind==='shift'){
      text = `${n.ep} ｜ ${n.map} ｜ ${n.level||''} ｜ 新分流 ${n.new_channel} ｜ 分流後移成功`;
    }
    return `<div class="notice ${colorClass}"><span class="dot"></span><span class="t">${tStr}</span><span>${text}</span></div>`;
  }).join("");
}
function pushNoticeLocally(n){
  notices.unshift(n);
  if(notices.length>3) notices.length=3;
  renderNotices();
}

/** ========= 表格 ========= */
function render(){
  let rows = Object.values(state.entries);
  if(state.filterEp && state.filterEp !== 'ALL'){
    rows = rows.filter(r => r.ep === state.filterEp);
  }
  if(state.filterMap && state.filterMap!=='ALL'){ rows = rows.filter(r=> r.map === state.filterMap); }
  rows = rows.sort((a,b)=>new Date(a.target_iso)-new Date(b.target_iso));
  tbody.innerHTML = rows.map(row=>{
    const t=new Date(row.target_iso), now=new Date();
    let cls=""; if(now>=t) cls="timeDue"; else if((t-now)<=10*60*1000) cls="timeSoon";
    const {bg,soft}=mapColor(row.map);
    const key=keyOf(row.ep,row.map,row.channel);
    const strike=row.dead?"timeStrike":"";
    return `<tr class="rowMap" data-key="${key}" style="border-left-color:${bg}; --row-soft:${soft}" data-soft>
      <td><input type="checkbox" class="chk" ${row.checked?'checked':''}></td>
      <td>${row.ep}</td>
      <td><span class="mapBadge"><span class="mapDot" style="background:${bg}"></span>${row.map}</span></td>
      <td><span class="pill">${row.level||''}</span></td>
      <td>${row.channel}</td>
      <td>
        <div class="timeWrap" style="display:flex;align-items:center;justify-content:flex-end;gap:8px">
          <span class="${cls} ${strike}">${fmtDisplayTime(t)}</span>
          <button class="btn small dead-btn">${row.dead?'取消':'標註死亡'}</button>
        </div>
      </td>
    </tr>`;
  }).join("");
}

/** ========= 新增/刪除/複製（樂觀更新＋自動同步） ========= */
function clamp(v,lo,hi){v=parseInt(v,10); if(isNaN(v)) v=0; return Math.max(lo,Math.min(hi,v));}

document.getElementById('addBtn').addEventListener('click', async ()=>{
  const ep=epSel.value, map=mapSel.value, level=levelInp.value||"", ch=chSel.value;
  const h=clamp(hhInp.value,0,99), m=clamp(mmInp.value,0,59), s=clamp(ssInp.value,0,59);
  if(!ep||!map||!ch) return alert('請完整選擇 EP / 地圖 / 分流');
  if(h===0&&m===0&&s===0) return alert('倒數時間不可為 0');

  const target=new Date(Date.now()+(h*3600+m*60+s)*1000).toISOString();
  const rowDb={ ep, map, level, channel: ch, target_iso: target, dead:false, updated_at:new Date().toISOString() };

  const { data, error } = await sb.from('entries').upsert(rowDb, { onConflict: 'ep,map,channel' }).select().single();
  if(error){ alert('新增失敗：'+error.message); return; }

  const key = keyOf(data.ep, data.map, data.channel);
  state.entries[key] = { ...data, checked:false, alertedBefore:false, alertedFinal:false };
  save(); render();

  // Insert notice (site-wide)
  await sb.from('notices').insert({ kind:'add', ep:data.ep, map:data.map, level:data.level, channel:data.channel });
});

document.getElementById('copyCheckedBtn').addEventListener('click', ()=>{
  const rows=Object.values(state.entries).filter(r=>r.checked).sort((a,b)=>new Date(a.target_iso)-new Date(b.target_iso));
  if(!rows.length) return alert('沒有勾選任何列');
  const text=rows.map(r=>{
    const lvl=String(r.level||"").replace(/^Lv\.?/i,''); const t=fmtTime(new Date(r.target_iso));
    return `${r.ep}-${lvl}-${r.channel}-${t}`;
  }).join('\\n');
  navigator.clipboard.writeText(text);
});
document.getElementById('copyAllBtn').addEventListener('click', ()=>{
  const rows=Object.values(state.entries).sort((a,b)=>new Date(a.target_iso)-new Date(b.target_iso));
  if(!rows.length) return alert('目前清單為空');
  const text=rows.map(r=>{
    const lvl=String(r.level||"").replace(/^Lv\\.?/i,''); const t=fmtTime(new Date(r.target_iso));
    return `${r.ep}-${lvl}-${r.channel}-${t}`;
  }).join('\\n');
  navigator.clipboard.writeText(text);
});
document.getElementById('delCheckedBtn').addEventListener('click', async ()=>{
  const keys=Object.values(state.entries).filter(v=>v.checked).map(v=>({ep:v.ep,map:v.map,channel:v.channel,level:v.level}));
  if(!keys.length) return alert('沒有勾選任何列');
  for(const k of keys){
    await sb.from('entries').delete().eq('ep',k.ep).eq('map',k.map).eq('channel',k.channel);
    // notice for each removed
    await sb.from('notices').insert({ kind:'del_checked', ep:k.ep, map:k.map, level:k.level, channel:k.channel });
    delete state.entries[keyOf(k.ep,k.map,k.channel)];
  }
  save(); render();
});
document.getElementById('delAllBtn').addEventListener('click', async ()=>{
  if(!confirm('確定要清除全部嗎？')) return;
  await sb.from('entries').delete().neq('ep','__never__');
  state.entries = {}; save(); render();
  await sb.from('notices').insert({ kind:'del_all' });
});

/** checkbox 本地專用（不寫 DB、不觸發同步） */
tbody.addEventListener('change', async (e)=>{
  if(!e.target.classList.contains('chk')) return;
  const tr=e.target.closest('tr'); const key=tr.dataset.key;
  const row=state.entries[key]; if(!row) return;
  row.checked = e.target.checked;
  state.entries[key]=row; save(); render();
});
/** 標註死亡（需要同步，寫 DB） */
tbody.addEventListener('click', async (e)=>{
  if(!e.target.classList.contains('dead-btn')) return;
  const tr=e.target.closest('tr'); const key=tr.dataset.key; const row=state.entries[key]; if(!row) return;
  const newDead = !row.dead;
  await sb.from('entries').update({dead: newDead, updated_at:new Date().toISOString()})
    .eq('ep',row.ep).eq('map',row.map).eq('channel',row.channel);
  row.dead = newDead; row.updated_at=new Date().toISOString();
  state.entries[key]=row; save(); render();
});

/** ========= 分流後移 ========= */
document.getElementById('shiftBtn').addEventListener('click', ()=>{
  shiftEp.value=epSel.value; refreshShiftMaps(); shiftMap.value=mapSel.value;
  shiftAt.value='1'; shiftMsg.textContent=''; shiftOverlay.classList.remove('hidden');
});
document.getElementById('shiftCancel').addEventListener('click', ()=>shiftOverlay.classList.add('hidden'));
shiftEp.addEventListener('change', refreshShiftMaps);
document.getElementById('shiftOk').addEventListener('click', async ()=>{
  const ep=shiftEp.value, map=shiftMap.value; let at=parseInt(shiftAt.value,10);
  if(!ep||!map||!at||at<1){ shiftMsg.textContent='請輸入正確的分流號（>=1）'; return; }
  const { data } = await sb.from('entries').select('*').eq('ep',ep).eq('map',map);
  const list=(data||[]).filter(r=>parseInt(r.channel,10)>=at).sort((a,b)=>parseInt(b.channel,10)-parseInt(a.channel,10));
  if(!list.length){ shiftMsg.textContent='沒有可後移的分流。'; return; }
  for(const r of list){
    const newCh=String(parseInt(r.channel,10)+1);
    await sb.from('entries').upsert({ ep:r.ep, map:r.map, level:r.level, channel:newCh, target_iso:r.target_iso, dead:r.dead, updated_at:new Date().toISOString() }, { onConflict:'ep,map,channel' });
    await sb.from('entries').delete().eq('ep',r.ep).eq('map',r.map).eq('channel',r.channel);
    state.entries[keyOf(r.ep,r.map,newCh)] = { ...r, channel:newCh, updated_at:new Date().toISOString() };
    delete state.entries[keyOf(r.ep,r.map,r.channel)];
  }
  save(); render();
  shiftOverlay.classList.add('hidden');

  // push one notice for the action (use the chosen insertion channel)
  await sb.from('notices').insert({ kind:'shift', ep:ep, map:map, level:(EP_MAP_LEVEL[ep]||{})[map]||'', new_channel:String(at) });
});

/** ========= 提示音 ========= */
soundToggle.addEventListener('change', ()=>{ state.soundEnabled=soundToggle.checked; save(); });
alertBefore.addEventListener('change', ()=>{ state.alertBeforeMin=parseInt(alertBefore.value,10)||0; save(); });

setInterval(()=>{
  const now=new Date(); const beforeMs=(state.alertBeforeMin||0)*60*1000;
  Object.values(state.entries).forEach(r=>{
    const t=new Date(r.target_iso).getTime();
    if(!r.alertedBefore && beforeMs>0 && now.getTime()>=(t-beforeMs) && now.getTime()<t){ beep(); r.alertedBefore=true; save(); }
    if(!r.alertedFinal && now.getTime()>=t){ beep(); r.alertedFinal=true; save(); }
  });
  render();
}, 1000);

/** 倒數控制按鈕 */
document.addEventListener('click', e=>{
  const btn=e.target.closest('.plusminus'); if(!btn) return;
  const id=btn.getAttribute('data-target'); const delta=parseInt(btn.getAttribute('data-delta'),10)||0;
  const input=document.getElementById(id); if(!input) return;
  let v=parseInt(input.value,10)||0; v+=delta;
  if(id==='hh') v=Math.max(0,Math.min(99,v)); else v=Math.max(0,Math.min(59,v));
  input.value=v;
});

/** ========= Realtime 同步（萬用事件 + 去重 + debounce resync） ========= */
let resyncTimer=null;
function scheduleResync(){ clearTimeout(resyncTimer); resyncTimer=setTimeout(()=>pullAll(), 500); }

async function startRealtime(){
  await pullAll();
  await pullNotices();

  const ch = sb.channel('entries-ch')
    .on('postgres_changes', { event:'*', schema:'public', table:'entries' }, payload => {
      const e = payload.eventType;
      if (e === 'INSERT' || e === 'UPDATE') {
        const r = payload.new;
        const k = keyOf(r.ep,r.map,r.channel);
        state.entries[k] = {
          ...r,
          checked: state.entries[k]?.checked || false, // 勾選僅本地
          alertedBefore: state.entries[k]?.alertedBefore || false,
          alertedFinal: state.entries[k]?.alertedFinal || false
        };
        if(payload.old){
          const ko = keyOf(payload.old.ep, payload.old.map, payload.old.channel);
          if(ko !== k){ delete state.entries[ko]; }
        }
      } else if (e === 'DELETE') {
        const r = payload.old;
        delete state.entries[keyOf(r.ep,r.map,r.channel)];
      }
      save(); render();
      scheduleResync();
    })
    .subscribe((status)=>{
      if(rtStatus){ rtStatus.textContent = `Realtime: ${status}`; }
    });

  // notices realtime
  const ch2 = sb.channel('notices-ch')
    .on('postgres_changes', { event:'INSERT', schema:'public', table:'notices' }, payload => {
      pushNoticeLocally(payload.new);
    })
    .subscribe();
}

/** ========= Presence（全站在線） ========= */
let presCh = null;
function getUserId(){
  const k='tomsboss_user_id';
  let id = localStorage.getItem(k);
  if(!id){ id = (crypto.randomUUID? crypto.randomUUID() : String(Math.random()).slice(2) + Date.now()); localStorage.setItem(k, id); }
  return id;
}
function updateOnlineBadge(stateObj){
  const count = Object.keys(stateObj||{}).length;
  if(onlineBadge) onlineBadge.textContent = `Online: ${count}`;
}
async function startPresence(){
  const userId = getUserId();
  presCh = sb.channel('presence:online', { config: { presence: { key: userId }}});

  presCh
    .on('presence', { event: 'sync' }, () => {
      const presenceState = presCh.presenceState();
      updateOnlineBadge(presenceState);
    })
    .subscribe(async (status) => {
      if(status === 'SUBSCRIBED'){
        try{ await presCh.track({ ts: Date.now() }); }catch(e){}
      }
    });

  window.addEventListener('beforeunload', () => {
    try{ presCh && presCh.untrack(); }catch{}
  });
}

async function pullAll(){
  const { data, error } = await sb.from('entries').select('*');
  if(error){ return; }
  const cur = state.entries;
  state.entries={};
  (data||[]).forEach(r=>{
    const k = keyOf(r.ep,r.map,r.channel);
    state.entries[k]={
      ...r,
      checked: cur[k]?.checked || false,
      alertedBefore: cur[k]?.alertedBefore || false,
      alertedFinal: cur[k]?.alertedFinal || false
    };
  });
  save(); render();
}

async function pullNotices(){
  const { data, error } = await sb.from('notices').select('*').order('created_at',{ascending:false}).limit(3);
  if(error){ return; }
  notices = data || [];
  renderNotices();
}

/** ========= 密碼驗證（RPC） ========= */
async function gate(){
  const overlay=document.getElementById('pwOverlay');
  const input=document.getElementById('pwInput');
  const okBtn=document.getElementById('pwOk');
  const cancelBtn=document.getElementById('pwCancel');
  const msg=document.getElementById('pwMsg');

  function setMsg(t){ msg.textContent=t||''; }
  overlay.classList.remove('hidden'); input.value=''; setMsg('（密碼由伺服器驗證）');

  async function tryCheck(){
    const pass=(input.value||'').trim();
    if(!pass){ setMsg('請先輸入密碼'); input.focus(); return; }
    okBtn.disabled=true; setMsg('驗證中…');
    try{
      const { data, error } = await sb.rpc('check_weekly_password', { p_pass: pass });
      if(error){ setMsg('伺服器錯誤，稍後再試'); okBtn.disabled=false; return; }
      if(data===true){
        overlay.classList.add('hidden'); setMsg('');
        await startRealtime();
        startPresence();
      } else {
        setMsg('密碼錯誤'); okBtn.disabled=false; input.select();
      }
    }catch(e){ setMsg('網路或伺服器異常'); okBtn.disabled=false; }
  }
  okBtn.onclick=tryCheck;
  input.onkeypress=(e)=>{ if(e.key==='Enter') tryCheck(); };
  cancelBtn.onclick=()=>{ overlay.classList.add('hidden'); };
}

/** ========= 啟動 ========= */
(async function init(){
  load();
  initSelectors();
  initEpFilter(); // 本機 EP 篩選
  buildMapOptionsFor(state.filterEp);
  epSel.addEventListener('change', refreshMaps);
  mapSel.addEventListener('change', refreshLevel);
  await gate();
})();
</script>
</body>
</html>
