<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>麥當勞單點專用_多人共用版v1（Web）</title>
<style>
  :root{--bg:#0b0f14;--card:#111827;--muted:#6b7280;--text:#e5e7eb;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;--border:#1f2937}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans","Helvetica Neue",Arial}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:22px;margin:0 0 16px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
  .toolbar .btn, .btn{background:#1f2937;border:1px solid var(--border);color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
  .toolbar .btn:hover, .btn:hover{border-color:#334155}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .sound{display:flex;align-items:center;gap:8px;color:var(--muted)}
  select,input[type="text"],input[type="number"],input[type="password"]{background:#0b1220;border:1px solid #22324a;color:#e5e7eb;padding:8px;border-radius:10px}
  input[type="number"]{width:80px;text-align:center}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;border-bottom:1px solid var(--border);text-align:center}
  th{color:#cbd5e1;font-weight:600}
  .timeSoon{color:var(--warn)}
  .timeDue{color:var(--bad);font-weight:700}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #2a3a56;border-radius:999px;color:#93c5fd;background:#0b1220}
  .muted{color:var(--muted)}
  .footer{margin-top:8px;font-size:12px;color:#94a3b8}
  .hidden{display:none!important}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:50}
  .modal{width:420px;max-width:92vw;background:#121826;border:1px solid #1f2a44;border-radius:14px;padding:18px}
  .modal h3{margin:0 0 10px;font-size:18px}
  .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
  .modal button{background:#1f2937;border:1px solid var(--border);color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
  .modal button.primary{background:#2563eb;border-color:#2563eb}

  .grid{display:grid;grid-template-columns:repeat(5, minmax(0,1fr));gap:10px}
  @media (max-width:900px){.grid{grid-template-columns:1fr 1fr}}

  .copy-toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111827;border:1px solid #334155;padding:8px 12px;border-radius:10px;color:#cbd5e1;opacity:0;transition:opacity .25s}
  .copy-toast.show{opacity:1}

  .btn.small{padding:2px 6px;font-size:12px}
  .time-ctrl{display:flex;align-items:center;gap:20px;flex-wrap:wrap}
  .time-unit{display:flex;align-items:center;gap:8px}
  .time-col{display:flex;flex-direction:column;gap:4px}
  .btn.small.square{width:38px;padding:6px 0;font-size:12px;text-align:center}

  tr.rowMap { border-left:6px solid transparent; }
  .mapBadge { display:inline-flex; align-items:center; gap:8px; justify-content:center }
  .mapDot { width:10px; height:10px; border-radius:50%; display:inline-block }

  .key-in.green{border:1px solid #3b8d3b;background:rgba(16,61,16,.25)}

  td.tdTime { text-align:right }
  .timeWrap{display:flex;align-items:center;justify-content:flex-end;gap:8px}
  .timeStrike{ text-decoration: line-through; opacity:.65 }
</style>
</head>
<body>

<!-- 分流後移對話框 -->
<div id="shiftOverlay" class="overlay hidden">
  <div class="modal">
    <h3>分流後移</h3>
    <div class="muted" style="margin:6px 0 4px">章節 (EP)</div>
    <select id="shiftEp" style="width:100%"></select>

    <div class="muted" style="margin:10px 0 4px">地圖名稱</div>
    <select id="shiftMap" style="width:100%"></select>

    <div class="muted" style="margin:10px 0 4px">插入的分流號（從這個分流開始往後 +1）</div>
    <input id="shiftAt" type="number" min="1" step="1" value="1" style="width:100%">

    <div class="actions">
      <button id="shiftCancel">取消</button>
      <button id="shiftOk" class="primary">確定後移</button>
    </div>
    <div id="shiftMsg" class="muted" style="margin-top:8px;font-size:12px"></div>
  </div>
</div>

<div class="container">
  <h1>麥當勞單點專用_多人共用版v1（Web）</h1>

  <div class="card">
    <div class="grid">
      <div>
        <div class="muted" style="margin-bottom:6px">章節 (EP)</div>
        <select id="ep"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">地圖名稱</div>
        <select id="map"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">等級</div>
        <input id="level" type="text" readonly>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">分流</div>
        <select id="channel"></select>
      </div>
      <div>
        <div class="muted" style="margin-bottom:6px">倒數時間</div>
        <div class="time-ctrl">
          <div class="time-unit">
            <div class="time-col">
              <button class="btn small square" data-target="hh" data-delta="-1">-1</button>
              <button class="btn small square" data-target="hh" data-delta="-5">-5</button>
            </div>
            <input id="hh" type="number" value="0" min="0" max="99" />
            <div class="time-col">
              <button class="btn small square" data-target="hh" data-delta="1">+1</button>
              <button class="btn small square" data-target="hh" data-delta="5">+5</button>
            </div>
            <span class="muted">時</span>
          </div>
          <div class="time-unit">
            <div class="time-col">
              <button class="btn small square" data-target="mm" data-delta="-1">-1</button>
              <button class="btn small square" data-target="mm" data-delta="-5">-5</button>
            </div>
            <input id="mm" type="number" value="0" min="0" max="59" />
            <div class="time-col">
              <button class="btn small square" data-target="mm" data-delta="1">+1</button>
              <button class="btn small square" data-target="mm" data-delta="5">+5</button>
            </div>
            <span class="muted">分</span>
          </div>
          <div class="time-unit">
            <div class="time-col">
              <button class="btn small square" data-target="ss" data-delta="-1">-1</button>
              <button class="btn small square" data-target="ss" data-delta="-5">-5</button>
            </div>
            <input id="ss" type="number" value="0" min="0" max="59" />
            <div class="time-col">
              <button class="btn small square" data-target="ss" data-delta="1">+1</button>
              <button class="btn small square" data-target="ss" data-delta="5">+5</button>
            </div>
            <span class="muted">秒</span>
          </div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:12px;align-items:center">
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="genKeyBtn" class="btn">產生紀錄</button>
        <input id="exportOut" class="key-in green" type="text" placeholder="生成的金鑰會顯示在這裡（自動複製）" style="width:420px" readonly>
      </div>
    </div>

    <div class="row" style="margin-top:12px;justify-content:space-between">
      <div class="toolbar">
        <button class="btn" id="addBtn">新增 BOSS</button>
        <button class="btn" id="copyCheckedBtn">複製勾選</button>
        <button class="btn" id="copyAllBtn">複製全部</button>
        <button class="btn" id="delCheckedBtn">清除勾選</button>
        <button class="btn" id="delAllBtn">清除全部</button>
        <button class="btn" id="shiftBtn">分流後移</button>
      </div>
      <div class="sound">
        <label><input type="checkbox" id="soundToggle" checked> 啟用提示鈴聲</label>
        <span>提前提示</span>
        <select id="alertBefore">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="3">3</option>
          <option value="5">5</option>
          <option value="10">10</option>
        </select>
        <span>分鐘</span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <table id="list">
      <thead>
        <tr>
          <th>✔</th>
          <th>章節</th>
          <th>地圖名稱</th>
          <th>等級</th>
          <th>分流</th>
          <th>時間</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="footer">依時間（實際到點）排序；相同「章節+地圖+分流」新增第二次會覆蓋第一次；資料即時同步（Supabase Realtime）。</div>
  </div>
</div>

<div id="toast" class="copy-toast">已複製到剪貼簿！</div>

<!-- ✅ 使用 UMD 版本，保證有 window.supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js" defer></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // 確保 SDK 已載入
  const waitSupabase = () => new Promise((resolve) => {
    if (window.supabase) return resolve();
    const timer = setInterval(() => {
      if (window.supabase){ clearInterval(timer); resolve(); }
    }, 10);
  });

  (async function main(){
    await waitSupabase();

    const SUPABASE_URL = "https://pvgisrubrsitesqpiimr.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB2Z2lzcnVicnNpdGVzcXBpaW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1MDExNjMsImV4cCI6MjA3MzA3NzE2M30.TQh3vDTpUkDJA58wA7EN3msFTHhz0c72TEXCl1Lg1zc";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== 其餘程式（與上一版相同） ===== */

    const EP_MAP_LEVEL = {
      "EP1": {"夏奧雷伊西邊森林":"Lv.1","夏奧雷伊東邊森林":"Lv.3","蓮帕拉沙池塘":"Lv.5","夏奧雷伊礦山村莊":"Lv.7","水晶礦山":"Lv.9"},
      "EP2": {"斯拉屋塔斯峽谷":"Lv.10","凱利高原":"Lv.11","奈普里塔斯懸崖":"Lv.12","泰內花園":"Lv.13","泰內聖堂地下1層":"Lv.15","泰內聖堂上1層":"Lv.17","泰內聖堂上2層":"Lv.19"},
      "EP3": {"庫魯森林":"Lv.20","克尼多斯森林":"Lv.21","達旦森林":"Lv.22","諾巴哈公會所":"Lv.24","諾巴哈別館":"Lv.26","諾巴哈本院":"Lv.28"},
      "EP4": {"貝雅山谷":"Lv.30","比爾塔溪谷":"Lv.31","科博爾特森林":"Lv.32","賽提尼山溝":"Lv.34","培爾克神殿":"Lv.36","安森塔水源地":"Lv.38"},
      "EP5": {"卡羅利斯泉水":"Lv.40","萊塔斯小溪":"Lv.42","德慕蘭佃農村":"Lv.44","德慕蘭莊園":"Lv.46","德慕蘭外城":"Lv.48"},
      "EP6": {"達伊納養蜂地":"Lv.50","比爾那森林":"Lv.51","烏奇斯耕作地":"Lv.52","春光樹林":"Lv.53","關口路":"Lv.55","史爾特凱拉特林":"Lv.57","克巴伊拉斯森林":"Lv.59"},
      "EP7": {"魯卡斯高原":"Lv.60","王之高原":"Lv.61","札卡里耶爾交叉路":"Lv.62","王陵1層":"Lv.64","王陵2層":"Lv.66","王陵3層":"Lv.68"},
      "EP8": {"水路橋地區":"Lv.70","魔族收監所第1區":"Lv.71","魔族收監所第3區":"Lv.72","魔族收監所第4區":"Lv.73","魔族收監所第5區":"Lv.74"},
      "EP9": {"女神的古院":"Lv.75","佩迪米安外城":"Lv.76","魔法師之塔1層":"Lv.77","魔法師之塔2層":"Lv.78","魔法師之塔3層":"Lv.79"},
      "EP10":{"大教堂懺悔路":"Lv.80","大教堂正殿":"Lv.81","大教堂大迴廊":"Lv.82","大教堂至聖所":"Lv.83"},
    };
    const CHANNELS = Array.from({length:10},(_,i)=>String(i+1));

    const pad2 = n => String(n).padStart(2,"0");
    const fmtTime = d => `${pad2(d.getHours())}:${pad2(d.getMinutes())}:${pad2(d.getSeconds())}`;
    function fmtDisplayTime(target){
      const now = new Date();
      const base = fmtTime(target);
      const startA = new Date(now); startA.setHours(0,0,0,0);
      const startB = new Date(target); startB.setHours(0,0,0,0);
      const dayDiff = Math.floor((startB - startA) / 86400000);
      return dayDiff===0 ? base : `${base} (+${dayDiff}d)`;
    }
    function strHash(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h + s.charCodeAt(i))|0; } return Math.abs(h); }
    function mapColor(mapName){
      const PALETTE=[12,42,72,102,132,162,192,222,252,282,312,342];
      const idx=Math.abs(strHash(mapName))%PALETTE.length;
      const h=PALETTE[idx];
      const alt=(Math.abs(strHash(mapName)>>4)%2)===0;
      const sStrong=72,lStrong=alt?42:35;
      const sSoft=70,lSoft=alt?30:26,ALPHA=.22;
      return { bg:`hsl(${h}deg, ${sStrong}%, ${lStrong}%)`, soft:`hsla(${h}, ${sSoft}%, ${lSoft}%, ${ALPHA})` };
    }
    function toast(msg="已複製到剪貼簿！"){
      const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),1000);
    }

    let rowsCache = [];

    const epSel = document.getElementById('ep');
    const mapSel = document.getElementById('map');
    const levelInp = document.getElementById('level');
    const chSel = document.getElementById('channel');
    const hhInp = document.getElementById('hh');
    const mmInp = document.getElementById('mm');
    const ssInp = document.getElementById('ss');
    const tbody = document.getElementById('tbody');

    const shiftOverlay = document.getElementById('shiftOverlay');
    const shiftEp = document.getElementById('shiftEp');
    const shiftMap = document.getElementById('shiftMap');
    const shiftAt = document.getElementById('shiftAt');
    const shiftMsg = document.getElementById('shiftMsg');

    const genKeyBtn = document.getElementById('genKeyBtn');
    const exportOut = document.getElementById('exportOut');

    function render(){
      const rows = [...rowsCache].sort((a,b)=>new Date(a.target_iso)-new Date(b.target_iso));
      tbody.innerHTML = rows.map(row=>{
        const target = new Date(row.target_iso);
        const now = new Date();
        let cls = "";
        if (now >= target) cls = "timeDue";
        else if ((target - now) <= 10*60*1000) cls = "timeSoon";

        const { bg, soft } = mapColor(row.map);
        const rowStyle = `border-left-color:${bg}; background:${soft}`;
        const timeStr = fmtDisplayTime(target);
        const strikeCls = row.dead ? "timeStrike" : "";

        return `<tr class="rowMap" data-id="${row.id}" style="${rowStyle}">
          <td><input type="checkbox" class="chk"></td>
          <td>${row.ep}</td>
          <td><span class="mapBadge"><span class="mapDot" style="background:${bg}"></span>${row.map}</span></td>
          <td><span class="pill">${row.level||""}</span></td>
          <td>${row.channel}</td>
          <td class="tdTime">
            <div class="timeWrap">
              <span class="${cls} ${strikeCls}">${timeStr}</span>
              <button class="btn small dead-btn">${row.dead ? '取消' : '標註死亡'}</button>
            </div>
          </td>
        </tr>`;
      }).join("");
    }

    async function fetchAll(){
      const { data, error } = await sb.from('entries').select('*').order('target_iso', { ascending: true });
      if (!error && Array.isArray(data)){ rowsCache = data; render(); }
    }

    async function upsertRow(ep, map, level, channel, secondsFromNow){
      const target = new Date(Date.now() + secondsFromNow*1000).toISOString();
      const payload = { ep, map, level, channel, target_iso: target, dead:false, checked:false };
      const { error } = await sb.from('entries').upsert(payload, { onConflict: 'ep,map,channel' }).select();
      if (error) alert('寫入失敗：' + error.message);
    }
    async function setDead(id, dead){ await sb.from('entries').update({ dead }).eq('id', id); }
    async function deleteChecked(){
      const ids = [...tbody.querySelectorAll('tr')].filter(tr=>tr.querySelector('.chk')?.checked).map(tr=>tr.dataset.id);
      if (!ids.length) { alert('沒有勾選'); return; }
      await sb.from('entries').delete().in('id', ids);
    }
    async function deleteAll(){
      if (!confirm('確定清除全部？')) return;
      await sb.from('entries').delete().neq('id', '00000000-0000-0000-0000-000000000000');
    }
    async function shiftChannels(ep, map, at){
      const { data, error } = await sb.from('entries').select('*').eq('ep', ep).eq('map', map);
      if (error){ shiftMsg.textContent = '讀取失敗：'+error.message; return; }
      const targets = (data||[])
        .map(r => ({ ...r, ch: parseInt(r.channel,10)||0 }))
        .filter(r => r.ch >= at)
        .sort((a,b)=> b.ch - a.ch);
      if (!targets.length){ shiftMsg.textContent = '沒有可後移的分流。'; return; }
      for (const row of targets){
        const newChannel = String(row.ch + 1);
        const { error: e1 } = await sb.from('entries').update({ channel: newChannel }).eq('id', row.id);
        if (e1){ shiftMsg.textContent = '更新失敗：'+e1.message; return; }
      }
      shiftMsg.textContent = `已將 ${ep} / ${map} 從分流 ${at} 起全部 +1`;
    }

    function initSelectors(){
      epSel.innerHTML = Object.keys(EP_MAP_LEVEL).map(ep=>`<option value="${ep}">${ep}</option>`).join("");
      document.getElementById('channel').innerHTML = Array.from({length:10},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join("");
      refreshMaps();
      shiftEp.innerHTML = epSel.innerHTML;
      refreshShiftMaps();
    }
    function refreshMaps(){
      const ep = epSel.value || Object.keys(EP_MAP_LEVEL)[0];
      const maps = Object.keys(EP_MAP_LEVEL[ep]||{});
      mapSel.innerHTML = maps.map(m=>`<option value="${m}">${m}</option>`).join("");
      refreshLevel();
    }
    function refreshLevel(){
      const ep=epSel.value, map=mapSel.value;
      levelInp.value = (EP_MAP_LEVEL[ep]||{})[map] || "";
    }
    function refreshShiftMaps(){
      const ep = shiftEp.value;
      const maps = Object.keys(EP_MAP_LEVEL[ep]||{});
      shiftMap.innerHTML = maps.map(m=>`<option value="${m}">${m}</option>`).join("");
    }

    document.getElementById('addBtn').addEventListener('click', async ()=>{
      const ep = epSel.value, map = mapSel.value, level = levelInp.value || "", ch = chSel.value;
      const h = Math.max(0, Math.min(99, parseInt(hhInp.value,10)||0));
      const m = Math.max(0, Math.min(59, parseInt(mmInp.value,10)||0));
      const s = Math.max(0, Math.min(59, parseInt(ssInp.value,10)||0));
      if (!ep || !map || !ch){ alert('請完整選擇 EP / 地圖 / 分流'); return; }
      if (h===0 && m===0 && s===0){ alert('倒數時間不可為 0'); return; }
      await upsertRow(ep, map, level, ch, h*3600 + m*60 + s);
    });
    document.getElementById('delCheckedBtn').addEventListener('click', deleteChecked);
    document.getElementById('delAllBtn').addEventListener('click', deleteAll);

    tbody.addEventListener('click', async (e)=>{
      if (e.target.classList.contains('dead-btn')){
        const tr = e.target.closest('tr'); const id = tr?.dataset?.id;
        if (!id) return;
        const row = rowsCache.find(r=>r.id===id);
        await setDead(id, !row?.dead);
      }
    });
    document.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-target]'); if (!btn) return;
      const id = btn.getAttribute('data-target');
      const delta = parseInt(btn.getAttribute('data-delta'),10) || 0;
      const input = document.getElementById(id); if (!input) return;
      let v = parseInt(input.value,10) || 0; v += delta;
      if (id === 'hh') v = Math.max(0, Math.min(99, v));
      if (id === 'mm' || id === 'ss') v = Math.max(0, Math.min(59, v));
      input.value = v;
    });

    epSel.addEventListener('change', refreshMaps);
    mapSel.addEventListener('change', refreshLevel);

    document.getElementById('shiftBtn').addEventListener('click', ()=>{
      shiftEp.value = epSel.value; refreshShiftMaps(); shiftMap.value = mapSel.value;
      shiftAt.value = '1'; shiftMsg.textContent = ''; shiftOverlay.classList.remove('hidden');
    });
    document.getElementById('shiftCancel').addEventListener('click', ()=>shiftOverlay.classList.add('hidden'));
    shiftEp.addEventListener('change', refreshShiftMaps);
    document.getElementById('shiftOk').addEventListener('click', async ()=>{
      const ep = shiftEp.value, map = shiftMap.value, at = parseInt(shiftAt.value,10) || 1;
      shiftMsg.textContent = '處理中…'; await shiftChannels(ep, map, at);
      setTimeout(()=>shiftOverlay.classList.add('hidden'), 600);
    });

    genKeyBtn.addEventListener('click', async ()=>{
      const { data, error } = await sb.from('entries').select('*');
      if (error){ alert('讀取失敗：'+error.message); return; }
      const CRC32_TABLE = (()=>{let c,t=[];for(let n=0;n<256;n++){c=n;for(let k=0;k<8;k++){c=((c&1)?(0xEDB88320^(c>>>1)):(c>>>1));}t[n]=c>>>0;}return t;})();
      function crc32(str){ let crc=0^(-1); for(let i=0;i<str.length;i++){ crc=(crc>>>8) ^ CRC32_TABLE[(crc^str.charCodeAt(i)) & 0xFF]; } return ((crc^(-1))>>>0).toString(16).padStart(8,'0'); }
      function b64encode(str){ return btoa(unescape(encodeURIComponent(str))); }
      const payload = { v:1, ts:Date.now(), entries:data };
      const json = JSON.stringify(payload);
      const b64 = b64encode(json);
      const sig = crc32(b64);
      const token = `TB1:${sig}:${b64}`;
      exportOut.value = token; navigator.clipboard.writeText(token).then(()=>toast('已產生並複製金鑰！'));
    });

    sb.channel('realtime:public:entries')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'entries' }, () => fetchAll())
      .subscribe();

    function initSelectors(){
      epSel.innerHTML = Object.keys(EP_MAP_LEVEL).map(ep=>`<option value="${ep}">${ep}</option>`).join("");
      chSel.innerHTML = CHANNELS.map(c=>`<option value="${c}">${c}</option>`).join("");
      refreshMaps(); shiftEp.innerHTML = epSel.innerHTML; refreshShiftMaps();
    }

    initSelectors();
    await fetchAll();
  })();
});
</script>
</body>
</html>
